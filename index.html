<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Laboratory Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .auto-refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            margin-left: 15px;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            opacity: 0.8;
        }

        .auto-refresh-indicator i {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }


        .controls {
            background: #f8fafc;
            padding: 30px 40px;
            border-bottom: 1px solid #e2e8f0;
        }

        .control-group {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 45px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .pc-status-container {
            padding: 30px 40px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
        }

        .pc-status-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .pc-status-card:hover {
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .pc-status-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .status-indicator-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #22c55e;
            position: relative;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        .status-indicator.offline {
            background: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline::after {
            animation: none;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            70% {
                transform: scale(2.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .pc-info h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #1f2937;
            font-weight: 700;
        }

        .pc-info .status-text {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pc-info .status-text i {
            font-size: 0.9rem;
        }

        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .system-info-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #4f46e5;
        }

        .system-info-item .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .system-info-item .value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: #f8fafc;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #4f46e5;
        }

        .stat-card .number {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
        }

        .tab-content {
            padding: 30px 40px;
            display: none;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 0 auto;
        }

        .chart-container canvas {
            max-height: 400px !important;
            max-width: 100% !important;
            width: 100% !important;
            height: 400px !important;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        tr:hover {
            background: #f8fafc;
        }


        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #374151;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #64748b;
        }

        /* Home/Dashboard Page Styles */
        .home-container {
            padding: 30px 40px;
            display: none;
        }

        .home-container.active {
            display: block;
        }

        .pcs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pc-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pc-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #4f46e5;
        }

        .pc-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .pc-card-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        .pc-card-status.offline {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .pc-card-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            flex: 1;
        }

        .pc-card-info {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 10px;
        }

        .pc-card-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .pc-card-info-item:last-child {
            border-bottom: none;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .view-toggle-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #64748b;
            margin-bottom: 30px;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header .subtitle {
                font-size: 0.9rem;
            }

            .controls {
                padding: 20px 15px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .form-group label {
                font-size: 0.85rem;
            }

            .form-group input, .form-group select {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 20px 15px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card i {
                font-size: 2rem;
            }

            .stat-card .number {
                font-size: 1.8rem;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .chart-container {
                padding: 20px 15px;
            }

            .chart-wrapper {
                height: 300px;
            }

            .data-table {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 12px 8px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-desktop"></i> RFID Laboratory Monitor</h1>
            <div class="subtitle" id="headerSubtitle">
                <span id="headerText">Enter PC name to get started</span>
                <span class="auto-refresh-indicator" id="refreshIndicator" style="display: none;">
                    <i class="fas fa-sync-alt"></i>
                    <span id="lastUpdateTime">Auto-refreshing...</span>
                </span>
            </div>
        </div>

        <!-- Home/Dashboard Page -->
        <div class="home-container active" id="homePage">
            <div class="view-toggle">
                <button class="view-toggle-btn active" onclick="showHomePage()">
                    <i class="fas fa-home"></i> Home
                </button>
                <button class="view-toggle-btn" onclick="showDetailPage()">
                    <i class="fas fa-desktop"></i> PC Details
                </button>
            </div>
            <h2 class="page-title">Available PCs</h2>
            <p class="page-subtitle">Click on a PC to view its details and activity</p>
            <div class="pcs-grid" id="pcsGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading PCs...
                </div>
            </div>
        </div>

        <!-- Detail Page -->
        <div class="home-container" id="detailPage">
            <div class="view-toggle">
                <button class="view-toggle-btn" onclick="showHomePage()">
                    <i class="fas fa-home"></i> Home
                </button>
                <button class="view-toggle-btn active" onclick="showDetailPage()">
                    <i class="fas fa-desktop"></i> PC Details
                </button>
            </div>
            <div class="controls">
                <div class="control-group">
                    <div class="form-group">
                        <label for="pcName"><i class="fas fa-desktop"></i> PC Name</label>
                        <input type="text" id="pcName" placeholder="Enter PC name (e.g., i3S)">
                    </div>
                    <div class="form-group">
                        <label for="selectedDate"><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="selectedDate">
                    </div>
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-search"></i>
                        Load Data
                    </button>
                </div>
            </div>

        <!-- PC Status Card -->
        <div class="pc-status-container" id="pcStatusContainer" style="display:none;">
            <div class="pc-status-card">
                <div class="pc-status-header">
                    <div class="status-indicator-wrapper">
                        <div class="status-indicator" id="statusIndicator"></div>
                    </div>
                    <div class="pc-info">
                        <h2 id="pcDisplayName"></h2>
                        <div class="status-text" id="pcStatusText">
                            <i class="fas fa-circle"></i>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="system-info-grid" id="systemInfoGrid">
                    <!-- System info will be populated here -->
                </div>
                <!-- Shareable Link Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">
                            <i class="fas fa-link"></i> Direct Link:
                        </label>
                        <input type="text" id="shareableLink" readonly 
                            style="flex: 1; min-width: 200px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background: #f8fafc; color: #374151;"
                            value="">
                        <button onclick="copyLink()" 
                            style="padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <p style="margin-top: 8px; font-size: 0.75rem; color: #64748b; font-style: italic;">
                        <i class="fas fa-info-circle"></i> Use this link for RFID tags or QR codes
                    </p>
                </div>
            </div>
        </div>

        <div id="statsGrid" class="stats-grid" style="display: none;"></div>

        <div id="apps-tab" class="tab-content" style="display: none;">
            <div class="chart-container">
                <div class="chart-title">App Usage Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="appUsageChart"></canvas>
                </div>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Memory</th>
                            <th>CPU</th>
                        </tr>
                    </thead>
                    <tbody id="appTableBody">
                        <!-- App data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loadingMessage" class="loading">
            Enter PC name and date to view activity data
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://uxhefdybgjluzkbodryd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4aGVmZHliZ2psdXprYm9kcnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDExMzAsImV4cCI6MjA3NjM3NzEzMH0.jvFSOUUNiWvLFdPHplVuRgvKkvt2zlet6NA_x3mLaJM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Set today's date as default
        document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];

        let appChart = null;
        let autoRefreshInterval = null;
        let pcStatusRefreshInterval = null;
        let lastUpdateTime = null;
        const PC_STATUS_REFRESH_INTERVAL = 5000; // 5 seconds for PC status
        const FULL_REFRESH_INTERVAL = 20000; // 20 seconds for full data reload

        // Auto-refresh functionality
        // PC status updates every 5 seconds, full data reload every 20 seconds
        function startAutoRefresh() {
            // Clear any existing intervals
            stopAutoRefresh();
            
            const pcName = document.getElementById('pcName').value.trim();
            if (!pcName) {
                return; // Don't start if no PC name
            }
            
            // Show indicator immediately (if it exists)
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.style.display = 'inline-flex';
            }
            updateLastUpdateTime();
            
            // Start PC status refresh interval (every 5 seconds)
            pcStatusRefreshInterval = setInterval(() => {
                const currentPcName = document.getElementById('pcName').value.trim();
                if (currentPcName) {
                    console.log('Auto-refresh: Updating PC status...');
                    refreshPcStatusOnly(currentPcName);
                } else {
                    stopAutoRefresh();
                }
            }, PC_STATUS_REFRESH_INTERVAL);
            
            // Start full data refresh interval (every 20 seconds)
            autoRefreshInterval = setInterval(() => {
                const currentPcName = document.getElementById('pcName').value.trim();
                if (currentPcName) {
                    // Simply call loadData() - it will reload everything
                    console.log('Auto-refresh: Full data reload...');
                    loadData();
                } else {
                    stopAutoRefresh();
                }
            }, FULL_REFRESH_INTERVAL);
            
            console.log('Auto-refresh started for PC:', pcName, '- PC status: 5s, Full reload: 20s');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (pcStatusRefreshInterval) {
                clearInterval(pcStatusRefreshInterval);
                pcStatusRefreshInterval = null;
            }
            console.log('Auto-refresh stopped');
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.style.display = 'none';
            }
        }

        // Refresh only PC status (faster, every 5 seconds)
        async function refreshPcStatusOnly(pcName) {
            try {
                // Fetch PC status
                let isOnline = false;
                let statusData = null;
                try {
                    const { data: statusDataResult, error: statusError } = await supabase
                        .from('pc_status')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!statusError && statusDataResult) {
                        statusData = statusDataResult;
                        isOnline = statusData.is_online || false;
                    }
                } catch (err) {
                    console.warn('Could not fetch PC status:', err);
                }

                // Fetch system info
                let systemInfo = null;
                try {
                    const { data: systemInfoData, error: systemInfoError } = await supabase
                        .from('system_info')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!systemInfoError && systemInfoData) {
                        systemInfo = systemInfoData;
                    }
                } catch (err) {
                    console.warn('Could not fetch system info:', err);
                }

                // Get selected date
                const selectedDate = document.getElementById('selectedDate').value || new Date().toISOString().split('T')[0];

                // Update PC status only
                updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate);
                
                // Update last update time
                updateLastUpdateTime();
            } catch (error) {
                console.error('Error refreshing PC status:', error);
            }
        }

        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            const timeStr = lastUpdateTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false 
            });
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `Last updated: ${timeStr}`;
            }
        }



        // Get URL parameters
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                pc: params.get('pc') || '',
                date: params.get('date') || ''
            };
        }

        // Update URL without reloading page
        function updateURL(pcName, date) {
            const url = new URL(window.location);
            if (pcName) {
                url.searchParams.set('pc', pcName);
            }
            if (date) {
                url.searchParams.set('date', date);
            }
            window.history.pushState({}, '', url);
        }

        // Check for URL parameters on page load
        function checkURLParams() {
            const params = getURLParams();
            if (params.pc) {
                document.getElementById('pcName').value = params.pc;
                if (params.date) {
                    document.getElementById('selectedDate').value = params.date;
                } else {
                    // If no date in URL, use today's date
                    document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];
                }
                // Auto-load data
                loadData();
            }
        }

        // Page navigation
        function showHomePage(event) {
            document.getElementById('homePage').classList.add('active');
            document.getElementById('detailPage').classList.remove('active');
            document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                document.querySelectorAll('.view-toggle-btn')[0].classList.add('active');
            }
            loadAllPCs();
        }

        function showDetailPage(event) {
            document.getElementById('homePage').classList.remove('active');
            document.getElementById('detailPage').classList.add('active');
            document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                document.querySelectorAll('.view-toggle-btn')[1].classList.add('active');
            }
        }

        function navigateToPC(pcName) {
            document.getElementById('pcName').value = pcName;
            showDetailPage();
            document.querySelector('.view-toggle-btn:last-child').classList.add('active');
            document.querySelector('.view-toggle-btn:first-child').classList.remove('active');
            loadData();
        }

        // Load all PCs for home page
        async function loadAllPCs() {
            const pcsGrid = document.getElementById('pcsGrid');
            pcsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading PCs...</div>';

            try {
                // Fetch all PC statuses
                const { data: pcStatuses, error: statusError } = await supabase
                    .from('pc_status')
                    .select('*')
                    .order('pc_name', { ascending: true });

                if (statusError) {
                    console.warn('Could not fetch PC statuses:', statusError);
                }

                // Fetch all system info
                const { data: systemInfos, error: systemError } = await supabase
                    .from('system_info')
                    .select('*')
                    .order('pc_name', { ascending: true });

                if (systemError) {
                    console.warn('Could not fetch system info:', systemError);
                }

                // Combine data
                const pcsMap = new Map();
                
                // Add PC statuses
                if (pcStatuses) {
                    pcStatuses.forEach(pc => {
                        pcsMap.set(pc.pc_name, {
                            pc_name: pc.pc_name,
                            is_online: pc.is_online || false,
                            last_seen: pc.last_seen,
                            last_activity: pc.last_activity,
                            systemInfo: null
                        });
                    });
                }

                // Add system info
                if (systemInfos) {
                    systemInfos.forEach(info => {
                        if (pcsMap.has(info.pc_name)) {
                            pcsMap.get(info.pc_name).systemInfo = info;
                        } else {
                            pcsMap.set(info.pc_name, {
                                pc_name: info.pc_name,
                                is_online: false,
                                last_seen: null,
                                last_activity: null,
                                systemInfo: info
                            });
                        }
                    });
                }

                // Display PCs
                if (pcsMap.size === 0) {
                    pcsGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-desktop"></i>
                            <h3>No PCs Found</h3>
                            <p>No PCs have been registered yet. Start the client application on a PC to register it.</p>
                        </div>
                    `;
                    return;
                }

                const pcsArray = Array.from(pcsMap.values());
                pcsGrid.innerHTML = pcsArray.map(pc => {
                    const isOnline = pc.is_online;
                    const statusClass = isOnline ? '' : 'offline';
                    const statusText = isOnline ? 'Online' : 'Offline';
                    
                    return `
                        <div class="pc-card" onclick="navigateToPC('${escapeHtml(pc.pc_name)}')">
                            <div class="pc-card-header">
                                <div class="pc-card-status ${statusClass}"></div>
                                <div class="pc-card-name">${escapeHtml(pc.pc_name)}</div>
                            </div>
                            <div class="pc-card-info">
                                <div class="pc-card-info-item">
                                    <span>Status:</span>
                                    <span style="color: ${isOnline ? '#22c55e' : '#ef4444'}; font-weight: 600;">${statusText}</span>
                                </div>
                                ${pc.systemInfo && pc.systemInfo.cpu_model ? `
                                    <div class="pc-card-info-item">
                                        <span>CPU:</span>
                                        <span>${escapeHtml(pc.systemInfo.cpu_model)}</span>
                                    </div>
                                ` : ''}
                                ${pc.systemInfo && pc.systemInfo.total_memory_gb ? `
                                    <div class="pc-card-info-item">
                                        <span>RAM:</span>
                                        <span>${pc.systemInfo.total_memory_gb} GB</span>
                                    </div>
                                ` : ''}
                                ${pc.last_seen ? `
                                    <div class="pc-card-info-item">
                                        <span>Last Seen:</span>
                                        <span>${formatDateTime(pc.last_seen)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading PCs:', error);
                pcsGrid.innerHTML = `
                    <div class="error" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading PCs. Please check your connection and try again.
                    </div>
                `;
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            const params = getURLParams();
            if (params.pc) {
                // If URL has PC parameter, show detail page
                showDetailPage();
                document.querySelector('.view-toggle-btn:last-child').classList.add('active');
                document.querySelector('.view-toggle-btn:first-child').classList.remove('active');
                checkURLParams();
            } else {
                // Otherwise show home page
                loadAllPCs();
            }
        });

        // Stop auto-refresh when page is hidden (tab switch)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                const pcName = document.getElementById('pcName').value.trim();
                if (pcName) {
                    startAutoRefresh();
                }
            }
        });

        async function loadData() {
            const pcName = document.getElementById('pcName').value.trim();
            let selectedDate = document.getElementById('selectedDate').value;

            if (!pcName) {
                alert('Please enter a PC name');
                return;
            }

            // If no date selected, use today's date
            if (!selectedDate) {
                selectedDate = new Date().toISOString().split('T')[0];
                document.getElementById('selectedDate').value = selectedDate;
            }

            // Update URL with current parameters
            updateURL(pcName, selectedDate);

            // Update header and show loading state
            document.getElementById('headerSubtitle').textContent = `PC: ${pcName} â€¢ ${selectedDate}`;
            document.getElementById('loadingMessage').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading data...';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('pcStatusContainer').style.display = 'none';
            document.getElementById('apps-tab').style.display = 'none';

            try {
                // Fetch PC status (handle case where table might not exist)
                let isOnline = false;
                let statusData = null;
                try {
                    const { data: statusDataResult, error: statusError } = await supabase
                        .from('pc_status')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!statusError && statusDataResult) {
                        statusData = statusDataResult;
                        isOnline = statusData.is_online || false;
                    }
                } catch (err) {
                    // Table might not exist, use default offline status
                    console.warn('Could not fetch PC status:', err);
                }

                // Fetch system info
                let systemInfo = null;
                try {
                    const { data: systemInfoData, error: systemInfoError } = await supabase
                        .from('system_info')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!systemInfoError && systemInfoData) {
                        systemInfo = systemInfoData;
                    }
                } catch (err) {
                    console.warn('Could not fetch system info:', err);
                }

                updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate);

                // Fetch app usage data
                const startDate = `${selectedDate}T00:00:00`;
                const endDate = `${selectedDate}T23:59:59`;

                const { data: appData, error: appError } = await supabase
                    .from('app_usage_logs')
                    .select('*')
                    .eq('pc_name', pcName)
                    .gte('start_time', startDate)
                    .lte('end_time', endDate)
                    .order('start_time', { ascending: false });

                if (appError) {
                    console.error('App data error:', appError);
                    throw appError;
                }

                // Process and display data
                processData(appData || []);

                // Update last update time
                updateLastUpdateTime();

                // Start auto-refresh (will reload data every 5 seconds)
                // Only start if not already running (to avoid multiple intervals)
                if (!autoRefreshInterval) {
                    startAutoRefresh();
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading data. Please check your connection and try again.
                    </div>`;
            }
        }

        function processData(appData) {
            console.log('Processing data:', appData.length, 'entries');
            
            // Calculate stats
            const totalAppSessions = appData.length;
            const totalAppTime = appData.reduce((sum, row) => sum + (row.duration_seconds || 0), 0);

            // Update stats grid
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <i class="fas fa-desktop"></i>
                        <div class="number">${totalAppSessions}</div>
                        <div class="label">App Sessions</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <div class="number">${formatDuration(totalAppTime)}</div>
                        <div class="label">Total Usage</div>
                    </div>
                `;
                statsGrid.style.display = 'grid';
            }

            // Populate tables
            populateAppTable(appData);

            // Create/update charts
            createAppChart(appData);

            // Show content (only hide loading message if it exists)
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }
            
            const appsTab = document.getElementById('apps-tab');
            if (appsTab) {
                appsTab.style.display = 'block';
            }
            
            console.log('Data processed and displayed');
        }

        function populateAppTable(appData) {
            const tbody = document.getElementById('appTableBody');

            if (appData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-desktop"></i>
                            <h3>No App Usage Data</h3>
                            <p>No application usage recorded for this date</p>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = appData.map(entry => {
                const duration = formatDuration(entry.duration_seconds || 0);
                const memory = entry.memory_usage_bytes ? formatBytes(entry.memory_usage_bytes) : 'N/A';
                const cpu = entry.cpu_percent ? `${Math.round(entry.cpu_percent)}%` : 'N/A';

                return `
                    <tr>
                        <td>${escapeHtml(entry.app_name)}</td>
                        <td>${formatTime(entry.start_time)}</td>
                        <td>${formatTime(entry.end_time)}</td>
                        <td>${duration}</td>
                        <td>${memory}</td>
                        <td>${cpu}</td>
                    </tr>
                `;
            }).join('');
        }


        function createAppChart(appData) {
            const chartCanvas = document.getElementById('appUsageChart');
            if (!chartCanvas) {
                console.warn('Chart canvas not found');
                return;
            }

            const ctx = chartCanvas.getContext('2d');
            const appUsage = {};

            appData.forEach(entry => {
                if (entry && entry.app_name) {
                    if (!appUsage[entry.app_name]) {
                        appUsage[entry.app_name] = 0;
                    }
                    appUsage[entry.app_name] += entry.duration_seconds || 0;
                }
            });

            // Destroy existing chart if it exists
            if (appChart) {
                appChart.destroy();
                appChart = null;
            }

            // Create new chart
            const labels = Object.keys(appUsage);
            const data = Object.values(appUsage).map(seconds => Math.round(seconds / 60));

            if (labels.length === 0) {
                console.log('No app data to display in chart');
                return;
            }

            appChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usage Time (minutes)',
                        data: data,
                        backgroundColor: '#4f46e5'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            });

            console.log('Chart updated with', labels.length, 'apps');
        }


        function updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate) {
            const statusIndicator = document.getElementById('statusIndicator');
            const pcDisplayName = document.getElementById('pcDisplayName');
            const pcStatusText = document.getElementById('pcStatusText');
            const systemInfoGrid = document.getElementById('systemInfoGrid');
            const pcStatusContainer = document.getElementById('pcStatusContainer');

            // Make sure the container is visible
            if (pcStatusContainer) {
                pcStatusContainer.style.display = 'block';
            }

            if (!pcDisplayName || !pcStatusText || !statusIndicator) {
                console.error('PC status elements not found');
                return;
            }

            pcDisplayName.textContent = pcName;
            
            const statusIcon = isOnline ? 'fa-check-circle' : 'fa-times-circle';
            const statusLabel = isOnline ? 'Online' : 'Offline';
            const statusColor = isOnline ? '#22c55e' : '#ef4444';
            
            pcStatusText.innerHTML = `
                <i class="fas ${statusIcon}" style="color: ${statusColor}"></i>
                <span>${statusLabel}</span>
            `;

            if (isOnline) {
                statusIndicator.classList.remove('offline');
            } else {
                statusIndicator.classList.add('offline');
            }

            console.log('PC Status updated:', { pcName, isOnline, hasStatusData: !!statusData, hasSystemInfo: !!systemInfo });

            // Display system info
            if (systemInfo) {
                systemInfoGrid.innerHTML = `
                    ${systemInfo.cpu_model ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-microchip"></i> CPU</div>
                            <div class="value">${escapeHtml(systemInfo.cpu_model)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.cpu_cores ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-layer-group"></i> Cores</div>
                            <div class="value">${systemInfo.cpu_cores}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.cpu_speed_ghz ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-tachometer-alt"></i> CPU Speed</div>
                            <div class="value">${systemInfo.cpu_speed_ghz} GHz</div>
                        </div>
                    ` : ''}
                    ${systemInfo.total_memory_gb ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-memory"></i> RAM</div>
                            <div class="value">${systemInfo.total_memory_gb} GB</div>
                        </div>
                    ` : ''}
                    ${systemInfo.os_platform ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-desktop"></i> OS</div>
                            <div class="value">${escapeHtml(systemInfo.os_platform)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.os_version ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-code-branch"></i> OS Version</div>
                            <div class="value">${escapeHtml(systemInfo.os_version)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.hostname ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-network-wired"></i> Hostname</div>
                            <div class="value">${escapeHtml(systemInfo.hostname)}</div>
                        </div>
                    ` : ''}
                    ${statusData && statusData.last_seen ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-clock"></i> Last Seen</div>
                            <div class="value">${formatDateTime(statusData.last_seen)}</div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Show basic info if system_info not available
                systemInfoGrid.innerHTML = `
                    ${statusData && statusData.last_seen ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-clock"></i> Last Seen</div>
                            <div class="value">${formatDateTime(statusData.last_seen)}</div>
                        </div>
                    ` : ''}
                    ${!systemInfo ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-info-circle"></i> System Info</div>
                            <div class="value">Not Available</div>
                        </div>
                    ` : ''}
                `;
            }

            document.getElementById('pcStatusContainer').style.display = 'block';
            
            // Update shareable link (use the selectedDate from the function parameter)
            updateShareableLink(pcName, selectedDate);
        }

        function updateShareableLink(pcName, date) {
            // Use current page URL
            const currentURL = window.location.origin + window.location.pathname;
            const url = new URL(currentURL);
            url.searchParams.set('pc', pcName);
            if (date) {
                url.searchParams.set('date', date);
            }
            const shareableLink = document.getElementById('shareableLink');
            if (shareableLink) {
                shareableLink.value = url.toString();
            }
        }

        function copyLink(event) {
            const linkInput = document.getElementById('shareableLink');
            if (!linkInput.value) return;
            
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            
            const copyToClipboard = () => {
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(linkInput.value).then(() => {
                            showCopyFeedback(event);
                        }).catch(() => {
                            // Fallback to execCommand
                            document.execCommand('copy');
                            showCopyFeedback(event);
                        });
                    } else {
                        // Fallback for older browsers
                        document.execCommand('copy');
                        showCopyFeedback(event);
                    }
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };
            
            copyToClipboard();
        }

        function showCopyFeedback(event) {
            const button = event ? event.target.closest('button') : document.querySelector('button[onclick="copyLink()"]');
            if (!button) return;
            
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';
            button.style.background = '#22c55e';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '#4f46e5';
            }, 2000);
        }


        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) {
                    // If it's not a valid date, try to parse as-is
                    return timeString;
                }
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true 
                });
            } catch (e) {
                return timeString;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            try {
                const date = new Date(dateTimeString);
                if (isNaN(date.getTime())) {
                    return dateTimeString;
                }
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return dateTimeString;
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '0m';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const mb = bytes / (1024 * 1024);
            return `${Math.round(mb * 10) / 10} MB`;
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
